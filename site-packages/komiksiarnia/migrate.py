from django.db import connection
from django.contrib.auth.models import User
from komiksy.models import Seria
from lusers.models import UserProfile

def migrate():
    cursor = connection.cursor()
    cursor.execute("SELECT * FROM users;")
    idmap = {}
    for id, username, password, strips, last_visit, max_id, site_message in cursor.fetchall():
        print 'migrate %s' % username

        u = User.objects.create_user(username, '', password)
        u.last_login = last_visit
        u.save()

        p = UserProfile(user=u, max_id=max_id)
        p.save()
        p.serie_ignorowane = Seria.objects.filter(
            tytul__in=phpserialize.dict_to_tuple(phpserialize.loads(strips)))
        p.save()

        idmap[id] = u.id

    for fr, to in idmap.items():
        cursor.execute("UPDATE tagi SET autor=%s WHERE autor=%s;", (fr, -to))
    cursor.execute("UPDATE tagi SET autor=-autor;")
    cursor.execute("ALTER TABLE tagi ADD COLUMN id INT NOT NULL PRIMARY KEY AUTO_INCREMENT;")
